name: Linux.Do Smart Random Check-in

on:
  schedule:
    # åˆ†æ•£åœ¨ä¸åŒæ—¶é—´ç‚¹ï¼Œæ¯å¤©åªä¼šæ‰§è¡Œå…¶ä¸­å‡ ä¸ª
    # UTCæ—¶é—´ï¼Œå¯¹åº”åŒ—äº¬æ—¶é—´+8å°æ—¶
    - cron: '23 1 * * *'    # åŒ—äº¬æ—¶é—´ 9:23
    - cron: '47 3 * * *'    # åŒ—äº¬æ—¶é—´ 11:47
    - cron: '31 6 * * *'    # åŒ—äº¬æ—¶é—´ 14:31
    - cron: '19 8 * * *'    # åŒ—äº¬æ—¶é—´ 16:19
    - cron: '53 10 * * *'   # åŒ—äº¬æ—¶é—´ 18:53
    - cron: '27 12 * * *'   # åŒ—äº¬æ—¶é—´ 20:27
    - cron: '41 14 * * *'   # åŒ—äº¬æ—¶é—´ 22:41
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  check-in:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.10'
        
    - name: Install system dependencies
      run: |
        sudo apt-get update
        sudo apt-get install -y wget gnupg
        wget -q -O - https://dl.google.com/linux/linux_signing_key.pub | sudo apt-key add -
        echo "deb [arch=amd64] http://dl.google.com/linux/chrome/deb/ stable main" | sudo tee /etc/apt/sources.list.d/google-chrome.list
        sudo apt-get update
        sudo apt-get install -y google-chrome-stable
        
    - name: Install Python dependencies
      run: |
        pip install --upgrade pip
        pip install -r requirements.txt
        
    - name: Smart Random Check-in
      env:
        LINUXDO_USERNAME: ${{ secrets.LINUXDO_USERNAME }}
        LINUXDO_PASSWORD: ${{ secrets.LINUXDO_PASSWORD }}
        BROWSE_ENABLED: ${{ secrets.BROWSE_ENABLED || 'true' }}
        GOTIFY_URL: ${{ secrets.GOTIFY_URL }}
        GOTIFY_TOKEN: ${{ secrets.GOTIFY_TOKEN }}
        SC3_PUSH_KEY: ${{ secrets.SC3_PUSH_KEY }}
        WXPUSH_URL: ${{ secrets.WXPUSH_URL }}
        WXPUSH_TOKEN: ${{ secrets.WXPUSH_TOKEN }}
      run: |
        # æ™ºèƒ½éšæœºæ‰§è¡Œï¼šåŸºäºæ—¥æœŸå†³å®šæ˜¯å¦æ‰§è¡Œ
        DATE_HASH=$(date +%d | md5sum | cut -c1-2)
        CURRENT_HOUR=$(date +%H)
        
        echo "æ—¥æœŸå“ˆå¸Œ: $DATE_HASH"
        echo "å½“å‰å°æ—¶(UTC): $CURRENT_HOUR"
        
        # å°†åå…­è¿›åˆ¶è½¬æ¢ä¸ºåè¿›åˆ¶ï¼Œç„¶åå†³å®šæ˜¯å¦æ‰§è¡Œ
        # è¿™æ ·æ¯å¤©ä¼šéšæœºæ‰§è¡Œ2-3ä¸ªæ—¶é—´ç‚¹
        EXEC_PROB=$((0x$DATE_HASH % 100))
        
        echo "æ‰§è¡Œæ¦‚ç‡: $EXEC_PROB%"
        
        # 35%çš„æ¦‚ç‡æ‰§è¡Œï¼ˆçº¦æ¯å¤©2-3æ¬¡ï¼‰
        if [ $EXEC_PROB -lt 35 ]; then
          echo "ğŸ² ä»Šå¤©è¿™ä¸ªæ—¶é—´ç‚¹æ‰§è¡Œç­¾åˆ°"
          
          # é¢å¤–çš„éšæœºå»¶è¿Ÿ
          RANDOM_DELAY=$((RANDOM % 1800))  # 0-30åˆ†é’Ÿçš„éšæœºå»¶è¿Ÿ
          echo "â±ï¸ é¢å¤–éšæœºå»¶è¿Ÿ: $((RANDOM_DELAY / 60))åˆ†$((RANDOM_DELAY % 60))ç§’"
          sleep $RANDOM_DELAY
          
          echo "ğŸš€ å¼€å§‹æ‰§è¡Œç­¾åˆ°è„šæœ¬..."
          python main.py
        else
          echo "ğŸ˜´ ä»Šå¤©è¿™ä¸ªæ—¶é—´ç‚¹è·³è¿‡æ‰§è¡Œ"
        fi
      continue-on-error: true